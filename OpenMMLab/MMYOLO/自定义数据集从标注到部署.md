# æµç¨‹

åœ¨å¹³æ—¶çš„å·¥ä½œå­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ä¸€äº›ä»»åŠ¡éœ€è¦è®­ç»ƒè‡ªå®šä¹‰çš„ç§æœ‰æ•°æ®é›†ï¼Œå¼€æºæ•°æ®é›†å»ä½œä¸ºä¸Šçº¿æ¨¡å‹çš„åœºæ™¯æ¯”è¾ƒå°‘ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬å¯¹è‡ªå·±çš„ç§æœ‰æ•°æ®é›†è¿›è¡Œä¸€ç³»åˆ—çš„æ“ä½œï¼Œä»¥ç¡®ä¿æ¨¡å‹èƒ½å¤Ÿä¸Šçº¿ç”Ÿäº§æœåŠ¡äºå®¢æˆ·ã€‚

æ­¥éª¤æ¦‚è§ˆå¦‚ä¸‹ï¼š

1. æ•°æ®é›†å‡†å¤‡ï¼š`tools/misc/download_dataset.py`
2. ä½¿ç”¨ `labelme` å’Œç®—æ³•è¿›è¡Œè¾…åŠ©å’Œä¼˜åŒ–æ•°æ®é›†æ ‡æ³¨ï¼š`demo/image_demo.py` + `labelme`
3. ä½¿ç”¨è„šæœ¬è½¬æ¢æˆ COCO æ•°æ®é›†æ ¼å¼ï¼š`tools/dataset_converters/labelme2coco.py`
4. æ•°æ®é›†åˆ’åˆ†ä¸ºè®­ç»ƒé›†ã€éªŒè¯é›†å’Œæµ‹è¯•é›†ï¼š`tools/misc/coco_split.py`
5. æ ¹æ®æ•°æ®é›†å†…å®¹æ–°å»º `config` æ–‡ä»¶
6. æ•°æ®é›†å¯è§†åŒ–åˆ†æï¼š`tools/analysis_tools/dataset_analysis.py`
7. ä¼˜åŒ– Anchor å°ºå¯¸ï¼š`tools/analysis_tools/optimize_anchors.py`
8. å¯è§†åŒ– config é…ç½®ä¸­æ•°æ®å¤„ç†éƒ¨åˆ†ï¼š`tools/analysis_tools/browse_dataset.py`
9.  è®­ç»ƒï¼š`tools/train.py`
10. æ¨ç†ï¼š`demo/image_demo.py`
11. éƒ¨ç½²

> ğŸ’¡ åœ¨è®­ç»ƒå¾—åˆ°æ¨¡å‹æƒé‡å’ŒéªŒè¯é›†çš„ mAP åï¼Œç”¨æˆ·éœ€è¦å¯¹é¢„æµ‹é”™è¯¯çš„ bad case è¿›è¡Œæ·±å…¥åˆ†æï¼Œä»¥ä¾¿ä¼˜åŒ–æ¨¡å‹ï¼ŒMMYOLO åœ¨åç»­ä¼šå¢åŠ è¿™ä¸ªåŠŸèƒ½ï¼Œæ•¬è¯·æœŸå¾…ã€‚

# 1. æ•°æ®é›†å‡†å¤‡

å¦‚æœæ‚¨ç°åœ¨æš‚æ—¶æ²¡æœ‰è‡ªå·±çš„æ•°æ®é›†ï¼Œäº¦æˆ–è€…æƒ³å°è¯•ç”¨ä¸€ä¸ªå°å‹æ•°æ®é›†æ¥è·‘é€šæˆ‘ä»¬çš„æ•´ä½“æµç¨‹ï¼Œå¯ä»¥ä½¿ç”¨æœ¬æ•™ç¨‹æä¾›çš„ä¸€ä¸ª 144 å¼ å›¾ç‰‡çš„ `cat` æ•°æ®é›†ï¼ˆæœ¬ `cat` æ•°æ®é›†ç”± @RangeKing æä¾›åŸå§‹å›¾ç‰‡ï¼Œç”± @PeterH0323 è¿›è¡Œæ•°æ®æ¸…æ´—ï¼‰ã€‚æœ¬æ•™ç¨‹çš„å‰©ä½™éƒ¨åˆ†éƒ½å°†ä»¥æ­¤ `cat` æ•°æ®é›†ä¸ºä¾‹è¿›è¡Œè®²è§£ã€‚

ä¸‹è½½ä¹Ÿéå¸¸ç®€å•ï¼Œåªéœ€è¦ä¸€æ¡å‘½ä»¤å³å¯å®Œæˆï¼ˆæ•°æ®é›†å‹ç¼©åŒ…å¤§å° 217 MBï¼‰ï¼š

```bash
python tools/misc/download_dataset.py \
    --dataset-name cat \
    --save-dir ./data/cat \
    --unzip --delete
```

è¯¥å‘½ä»¤ä¼šè‡ªåŠ¨ä¸‹è½½æ•°æ®é›†åˆ° `./data/cat` æ–‡ä»¶å¤¹ä¸­ï¼Œè¯¥æ–‡ä»¶çš„ç›®å½•ç»“æ„æ˜¯ï¼š

```
.
â””â”€â”€ ./data/cat
    â”œâ”€â”€ images # å›¾ç‰‡æ–‡ä»¶
    â”‚    â”œâ”€â”€ image1.jpg
    â”‚    â”œâ”€â”€ image2.png
    â”‚    â””â”€â”€ ...
    â”œâ”€â”€ labels # labelme æ ‡æ³¨æ–‡ä»¶
    â”‚    â”œâ”€â”€ image1.json
    â”‚    â”œâ”€â”€ image2.json
    â”‚    â””â”€â”€ ...
    â”œâ”€â”€ annotations # æ•°æ®é›†åˆ’åˆ†çš„ COCO æ–‡ä»¶
    â”‚    â”œâ”€â”€ annotations_all.json # å…¨é‡æ•°æ®çš„ COCO label æ–‡ä»¶
    â”‚    â”œâ”€â”€ trainval.json # åˆ’åˆ†æ¯”ä¾‹ 80% çš„æ•°æ®
    â”‚    â””â”€â”€ test.json # åˆ’åˆ†æ¯”ä¾‹ 20% çš„æ•°æ®
    â””â”€â”€ class_with_id.txt # id + class_name æ–‡ä»¶
```

è¿™ä¸ªæ•°æ®é›†å¯ä»¥ç›´æ¥è®­ç»ƒï¼Œå¦‚æœæ‚¨æƒ³ä½“éªŒæ•´ä¸ªæµç¨‹çš„è¯ï¼Œå¯ä»¥å°† `images` æ–‡ä»¶å¤¹ä»¥å¤–çš„å…¶ä½™æ–‡ä»¶éƒ½åˆ é™¤ã€‚

# 2. ä½¿ç”¨ labelme å’Œç®—æ³•è¿›è¡Œè¾…åŠ©å’Œä¼˜åŒ–æ•°æ®é›†æ ‡æ³¨

é€šå¸¸ï¼Œæ ‡æ³¨æœ‰ 2 ç§æ–¹æ³•ï¼š

1. è½¯ä»¶æˆ–è€…ç®—æ³•è¾…åŠ© + äººå·¥ä¿®æ­£ labelï¼ˆæ¨èï¼Œé™æœ¬æé€Ÿï¼‰
2. ä»…äººå·¥æ ‡æ³¨

## 2.1 è½¯ä»¶æˆ–è€…ç®—æ³•è¾…åŠ© + äººå·¥ä¿®æ­£ label

è¾…åŠ©æ ‡æ³¨çš„åŸç†æ˜¯ç”¨å·²æœ‰æ¨¡å‹è¿›è¡Œæ¨ç†ï¼Œå°†å¾—å‡ºçš„æ¨ç†ä¿¡æ¯ä¿å­˜ä¸ºæ ‡æ³¨è½¯ä»¶ label æ–‡ä»¶æ ¼å¼ã€‚ç„¶åäººå·¥æ“ä½œæ ‡æ³¨è½¯ä»¶åŠ è½½ç”Ÿæˆå¥½çš„ label æ–‡ä»¶ï¼Œåªéœ€è¦æ£€æŸ¥æ¯å¼ å›¾ç‰‡çš„ç›®æ ‡æ˜¯å¦æ ‡å‡†ï¼Œä»¥åŠæ˜¯å¦æœ‰æ¼æ‰ã€é”™æ ‡çš„ç›®æ ‡ã€‚ã€è½¯ä»¶æˆ–è€…ç®—æ³•è¾…åŠ© + äººå·¥ä¿®æ­£ labelã€‘è¿™ç§æ–¹å¼å¯ä»¥èŠ‚çœå¾ˆå¤šæ—¶é—´å’Œç²¾åŠ›ï¼Œè¾¾åˆ°é™æœ¬æé€Ÿçš„ç›®çš„ã€‚

> ğŸ’¡  å¦‚æœå·²æœ‰æ¨¡å‹ï¼ˆå…¸å‹çš„å¦‚ COCO é¢„è®­ç»ƒæ¨¡å‹ï¼‰æ²¡æœ‰æ‚¨è‡ªå®šä¹‰æ–°æ•°æ®é›†çš„ç±»åˆ«ï¼Œå»ºè®®å…ˆäººå·¥æ‰“ 100 å¼ å·¦å³çš„å›¾ç‰‡ labelï¼Œè®­ç»ƒä¸ªåˆå§‹æ¨¡å‹ï¼Œç„¶åå†è¿›è¡Œè¾…åŠ©æ ‡æ³¨ã€‚

ä¸‹é¢ä¼šåˆ†åˆ«ä»‹ç»å…¶è¿‡ç¨‹ï¼š

### 2.1.1 è½¯ä»¶æˆ–è€…ç®—æ³•è¾…åŠ©

ä½¿ç”¨ MMYOLO æä¾›çš„æ¨¡å‹æ¨ç†è„šæœ¬ `demo/image_demo.py`ï¼Œå¹¶è®¾ç½® `--to-labelme` åˆ™å¯ä»¥å°†æ¨ç†ç»“æœç”Ÿæˆ labelme æ ¼å¼çš„ label æ–‡ä»¶ï¼Œå…·ä½“ç”¨æ³•å¦‚ä¸‹ï¼š

```bash
python demo/image_demo.py img \
                          config \
                          checkpoint
                          [--out-dir OUT_DIR] \
                          [--device DEVICE] \
                          [--show] \
                          [--deploy] \
                          [--score-thr SCORE_THR] \
                          [--class-name CLASS_NAME]
                          [--to-labelme]
```

å…¶ä¸­ï¼š

- `img`: å›¾ç‰‡çš„è·¯å¾„ï¼Œæ”¯æŒæ–‡ä»¶å¤¹ã€æ–‡ä»¶ã€URLï¼›
- `config`: ç”¨åˆ°çš„æ¨¡å‹ config æ–‡ä»¶è·¯å¾„ï¼›
- `checkpoint`: ç”¨åˆ°çš„æ¨¡å‹æƒé‡æ–‡ä»¶è·¯å¾„ï¼›
- `--out-dir`: æ¨ç†ç»“æœè¾“å‡ºåˆ°æŒ‡å®šç›®å½•ä¸‹ï¼Œé»˜è®¤ä¸º `./output`ï¼Œå½“ `--show` å‚æ•°å­˜åœ¨æ—¶ï¼Œä¸ä¿å­˜æ£€æµ‹ç»“æœï¼›
- `--device`: ä½¿ç”¨çš„è®¡ç®—èµ„æºï¼ŒåŒ…æ‹¬ CUDA, CPU ç­‰ï¼Œé»˜è®¤ä¸º `cuda:0`ï¼›
- `--show`: ä½¿ç”¨è¯¥å‚æ•°è¡¨ç¤ºåœ¨å±å¹•ä¸Šæ˜¾ç¤ºæ£€æµ‹ç»“æœï¼Œé»˜è®¤ä¸º `False`ï¼›
- `--deploy`: æ˜¯å¦åˆ‡æ¢æˆ `deploy` æ¨¡å¼ï¼›
- `--score-thr`: ç½®ä¿¡åº¦é˜ˆå€¼ï¼Œé»˜è®¤ä¸º 0.3ï¼›
- `--to-labelme`: æ˜¯å¦å¯¼å‡º labelme æ ¼å¼çš„ label æ–‡ä»¶ï¼Œä¸å¯ä»¥ä¸ `--show` å‚æ•°åŒæ—¶å­˜åœ¨

**ä¾‹å­**ï¼š

è¿™é‡Œä½¿ç”¨ YOLOv5-s ä½œä¸ºä¾‹å­æ¥è¿›è¡Œè¾…åŠ©æ ‡æ³¨åˆšåˆšä¸‹è½½çš„ cat æ•°æ®é›†ï¼Œå…ˆä¸‹è½½ YOLOv5-s çš„æƒé‡:

```bash
mkdir work_dirs
wget -P ./work_dirs https://download.openmmlab.com/mmyolo/v0/yolov5/yolov5_s-v61_syncbn_fast_8xb16-300e_coco/yolov5_s-v61_syncbn_fast_8xb16-300e_coco_20220918_084700-86e02187.pth 
```

ç”±äº COCO 80 ç±»æ•°æ®é›†ä¸­å·²ç»åŒ…æ‹¬äº† cat è¿™ä¸€ç±»ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥åŠ è½½ COCO é¢„è®­ç»ƒæƒé‡è¿›è¡Œè¾…åŠ©æ ‡æ³¨ã€‚

```bash
python demo/image_demo.py ./data/cat/images \
                          ./configs/yolov5/yolov5_s-v61_syncbn_fast_8xb16-300e_coco.py \
                          ./work_dirs/yolov5_s-v61_syncbn_fast_8xb16-300e_coco_20220918_084700-86e02187.pth \
                          --out-dir ./data/cat/labels \
                          --class-name cat \
                          --to-labelme
```

> ğŸ’¡ 
> - å¦‚æœæ‚¨çš„æ•°æ®é›†éœ€è¦æ ‡æ³¨å¤šç±»ï¼Œå¯ä»¥é‡‡ç”¨ç±»ä¼¼ `--class-name class1 class2` æ ¼å¼è¾“å…¥ï¼›
> - å¦‚æœå…¨éƒ¨è¾“å‡ºï¼Œåˆ™åˆ æ‰ `--class-name` è¿™ä¸ª flag å³å¯å…¨éƒ¨ç±»éƒ½è¾“å‡ºã€‚

ç”Ÿæˆçš„ label æ–‡ä»¶ä¼šåœ¨ `--out-dir` ä¸­:

```
.
â””â”€â”€ $OUT_DIR
    â”œâ”€â”€ image1.json
    â”œâ”€â”€ image1.json
    â””â”€â”€ ...
```

è¿™æ˜¯ä¸€å¼ åŸå›¾åŠå…¶ç”Ÿæˆçš„ json ä¾‹å­ï¼š

<div align=center>
    <img src=./imgs_markdown/2024-03-01-09-06-44.png
    width=100%>
    <center></center>
</div>

### 2.1.2 äººå·¥æ ‡æ³¨<a id=äººå·¥æ ‡æ³¨></a>

æœ¬æ•™ç¨‹ä½¿ç”¨çš„æ ‡æ³¨è½¯ä»¶æ˜¯ labelmeã€‚

ã€”**å®‰è£… labelme**ã€•

```bash
pip install labelme -i https://pypi.tuna.tsinghua.edu.cn/simple
```

ã€”**å¯åŠ¨ labelme**ã€•

```bash
labelme ${å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„ï¼ˆå³ä¸Šä¸€æ­¥çš„å›¾ç‰‡æ–‡ä»¶å¤¹ï¼‰} \
        --output ${labelæ–‡ä»¶æ‰€å¤„çš„æ–‡ä»¶å¤¹è·¯å¾„ï¼ˆå³ä¸Šä¸€æ­¥çš„ --out-dirï¼‰} \
        --autosave \
        --nodata
```

å…¶ä¸­ï¼š

- `--output`ï¼šlabelme æ ‡æ³¨æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼Œå¦‚æœè¯¥è·¯å¾„ä¸‹å·²ç»å­˜åœ¨éƒ¨åˆ†å›¾ç‰‡çš„æ ‡æ³¨æ–‡ä»¶ï¼Œåˆ™ä¼šè¿›è¡ŒåŠ è½½ï¼›
- `--autosave`ï¼šæ ‡æ³¨æ–‡ä»¶è‡ªåŠ¨ä¿å­˜ï¼Œä¼šç•¥å»ä¸€äº›ç¹ççš„ä¿å­˜æ­¥éª¤ï¼›
- `--nodata`ï¼šğŸ’¡  æ¯å¼ å›¾ç‰‡çš„æ ‡æ³¨æ–‡ä»¶ä¸­ä¸ä¿å­˜å›¾ç‰‡çš„ base64 ç¼–ç ï¼Œ<font color='red'><b>è®¾ç½®äº†è¿™ä¸ª flag ä¼šå¤§å¤§å‡å°‘æ ‡æ³¨æ–‡ä»¶çš„å¤§å°</b></font>ã€‚

ã€”**ä¾‹å­**ã€•

```bash
cd /path/to/mmyolo
labelme ./data/cat/images \
    --output ./data/cat/labels \
    --autosave \
    --nodata
```

è¾“å…¥å‘½ä»¤ä¹‹å labelme å°±ä¼šå¯åŠ¨ï¼Œç„¶åè¿›è¡Œ label æ£€æŸ¥å³å¯ã€‚

> ğŸ’¡  
> - å¦‚æœ labelme å¯åŠ¨å¤±è´¥ï¼Œå‘½ä»¤è¡Œè¾“å…¥ `export QT_DEBUG_PLUGINS=1` æŸ¥çœ‹å…·ä½“ç¼ºå°‘ä»€ä¹ˆåº“ï¼Œå®‰è£…ä¸€ä¸‹å³å¯
> - æ ‡æ³¨çš„æ—¶å€™åŠ¡å¿…ä½¿ç”¨ `rectangle`ï¼Œå¿«æ·é”® `Ctrl + R`

## 2.2 ä»…äººå·¥æ ‡æ³¨

æ­¥éª¤å’Œã€”[2.1.2 äººå·¥æ ‡æ³¨](#äººå·¥æ ‡æ³¨)ã€•ç›¸åŒï¼Œåªæ˜¯è¿™é‡Œæ˜¯ç›´æ¥æ ‡æ³¨ï¼Œæ²¡æœ‰é¢„å…ˆç”Ÿæˆçš„ label ã€‚

# 3. ä½¿ç”¨è„šæœ¬è½¬æ¢æˆ COCO æ•°æ®é›†æ ¼å¼

## 3.1 ä½¿ç”¨è„šæœ¬è½¬æ¢

MMYOLO æä¾›è„šæœ¬å°† labelme çš„ label è½¬æ¢ä¸º COCO labelï¼š

```bash
python tools/dataset_converters/labelme2coco.py --img-dir ${å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„} \
                                                --labels-dir ${label æ–‡ä»¶å¤¹ä½ç½®} \
                                                --out ${è¾“å‡º COCO label json è·¯å¾„} \
                                                [--class-id-txt ${class_with_id.txt è·¯å¾„}]
```

å…¶ä¸­ `--class-id-txt` æ˜¯æ•°æ®é›† `id class_name` çš„ `.txt` æ–‡ä»¶ï¼š
- å¦‚æœä¸æŒ‡å®šï¼Œåˆ™è„šæœ¬ä¼šè‡ªåŠ¨ç”Ÿæˆï¼Œç”Ÿæˆåœ¨ `--out` åŒçº§çš„ç›®å½•ä¸­ï¼Œä¿å­˜æ–‡ä»¶åä¸º `class_with_id.txt`ï¼›
- å¦‚æœæŒ‡å®šï¼Œè„šæœ¬ä»…ä¼šè¿›è¡Œè¯»å–ä½†ä¸ä¼šæ–°å¢æˆ–è€…è¦†ç›–ï¼ŒåŒæ—¶ï¼Œè„šæœ¬é‡Œé¢è¿˜ä¼šåˆ¤æ–­æ˜¯å¦å­˜åœ¨ `.txt` ä¸­å…¶ä»–çš„ç±»ï¼Œå¦‚æœå‡ºç°äº†ä¼šæŠ¥é”™æç¤ºï¼Œå±Šæ—¶ï¼Œè¯·ç”¨æˆ·æ£€æŸ¥ `.txt` æ–‡ä»¶å¹¶åŠ å…¥æ–°çš„ç±»åŠå…¶ `id`ã€‚

`.txt` æ–‡ä»¶çš„ä¾‹å­å¦‚ä¸‹ï¼ˆ `id` å¯ä»¥å’Œ COCO ä¸€æ ·ï¼Œä» `1` å¼€å§‹ï¼‰ï¼š

```
1 cat
2 dog
3 bicycle
4 motorcycle
```

ã€”**ä¾‹å­**ã€•ä»¥æœ¬æ•™ç¨‹çš„ cat æ•°æ®é›†ä¸ºä¾‹ï¼š

```bash
python tools/dataset_converters/labelme2coco.py --img-dir ./data/cat/images \
                                                --labels-dir ./data/cat/labels \
                                                --out ./data/cat/annotations/annotations_all.json
```

æœ¬æ¬¡æ¼”ç¤ºçš„ cat æ•°æ®é›†ï¼ˆæ³¨æ„ä¸éœ€è¦åŒ…æ‹¬èƒŒæ™¯ç±»ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„ `class_with_id.txt` ä¸­åªæœ‰ 1 ç±»ï¼š

```
1 cat

```

## 3.2 æ£€æŸ¥è½¬æ¢çš„ COCO label

ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å¯ä»¥å°† COCO çš„ label åœ¨å›¾ç‰‡ä¸Šè¿›è¡Œæ˜¾ç¤ºï¼Œè¿™ä¸€æ­¥å¯ä»¥éªŒè¯åˆšåˆšè½¬æ¢æ˜¯å¦æœ‰é—®é¢˜ï¼š

```bash
python tools/analysis_tools/browse_coco_json.py --img-dir ${å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„} \
                                                --ann-file ${COCO label json è·¯å¾„}
```

ã€”**ä¾‹å­**ã€•

```bash
python tools/analysis_tools/browse_coco_json.py --img-dir ./data/cat/images \
                                                --ann-file ./data/cat/annotations/annotations_all.json
```

# 4. æ•°æ®é›†åˆ’åˆ†ä¸ºè®­ç»ƒé›†ã€éªŒè¯é›†å’Œæµ‹è¯•é›†

é€šå¸¸ï¼Œè‡ªå®šä¹‰å›¾ç‰‡éƒ½æ˜¯ä¸€ä¸ªå¤§æ–‡ä»¶å¤¹ï¼Œé‡Œé¢å…¨éƒ¨éƒ½æ˜¯å›¾ç‰‡ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±å»å¯¹å›¾ç‰‡è¿›è¡Œè®­ç»ƒé›†ã€éªŒè¯é›†ã€æµ‹è¯•é›†çš„åˆ’åˆ†ï¼Œå¦‚æœæ•°æ®é‡æ¯”è¾ƒå°‘ï¼Œå¯ä»¥ä¸åˆ’åˆ†éªŒè¯é›†ã€‚ä¸‹é¢æ˜¯åˆ’åˆ†è„šæœ¬çš„å…·ä½“ç”¨æ³•ï¼š

```bash
python tools/misc/coco_split.py --json ${COCO label json è·¯å¾„} \
                                --out-dir ${åˆ’åˆ† label json ä¿å­˜æ ¹è·¯å¾„} \
                                --ratios ${åˆ’åˆ†æ¯”ä¾‹} \
                                [--shuffle] \
                                [--seed ${åˆ’åˆ†çš„éšæœºç§å­}]
```

å…¶ä¸­ï¼š

- `--ratios`ï¼šåˆ’åˆ†çš„æ¯”ä¾‹ï¼Œå¦‚æœåªè®¾ç½®äº† 2 ä¸ªï¼Œåˆ™åˆ’åˆ†ä¸º `trainval + test`ï¼Œå¦‚æœè®¾ç½®ä¸º 3 ä¸ªï¼Œåˆ™åˆ’åˆ†ä¸º `train + val + test`ã€‚æ”¯æŒä¸¤ç§æ ¼å¼ â€”â€” æ•´æ•°ã€å°æ•°ï¼š
  - æ•´æ•°ï¼šæŒ‰æ¯”ä¾‹è¿›è¡Œåˆ’åˆ†ï¼Œä»£ç ä¸­ä¼šè¿›è¡Œå½’ä¸€åŒ–ä¹‹ååˆ’åˆ†æ•°æ®é›†ã€‚ä¾‹å­ï¼š `--ratio 2 1 1`ï¼ˆä»£ç é‡Œé¢ä¼šè½¬æ¢æˆ `0.5 0.25 0.25`ï¼‰ or `--ratio 3 1`ï¼ˆä»£ç é‡Œé¢ä¼šè½¬æ¢æˆ `0.75 0.25`ï¼‰
  - å°æ•°ï¼šåˆ’åˆ†ä¸ºæ¯”ä¾‹ã€‚å¦‚æœåŠ èµ·æ¥ä¸ä¸º 1 ï¼Œåˆ™è„šæœ¬ä¼šè¿›è¡Œè‡ªåŠ¨å½’ä¸€åŒ–ä¿®æ­£ã€‚ä¾‹å­ï¼š `--ratio 0.8 0.1 0.1` or `--ratio 0.8 0.2`
- `--shuffle`: æ˜¯å¦æ‰“ä¹±æ•°æ®é›†å†è¿›è¡Œåˆ’åˆ†ï¼›
- `--seed`ï¼šè®¾å®šåˆ’åˆ†çš„éšæœºç§å­ï¼Œä¸è®¾ç½®çš„è¯è‡ªåŠ¨ç”Ÿæˆéšæœºç§å­ã€‚

ã€”**ä¾‹å­**ã€•

```bash
python tools/misc/coco_split.py --json ./data/cat/annotations/annotations_all.json \
                                --out-dir ./data/cat/annotations \
                                --ratios 0.8 0.2 \
                                --shuffle \
                                --seed 10
```

# 5. æ ¹æ®æ•°æ®é›†å†…å®¹æ–°å»º config æ–‡ä»¶

ç¡®ä¿æ•°æ®é›†ç›®å½•æ˜¯è¿™æ ·çš„ï¼š

```
.
â””â”€â”€ $DATA_ROOT
    â”œâ”€â”€ annotations
    â”‚    â”œâ”€â”€ trainval.json # æ ¹æ®ä¸Šé¢çš„æŒ‡ä»¤åªåˆ’åˆ† trainval + testï¼Œå¦‚æœæ‚¨ä½¿ç”¨ 3 ç»„åˆ’åˆ†æ¯”ä¾‹çš„è¯ï¼Œè¿™é‡Œæ˜¯ train.jsonã€val.jsonã€test.json
    â”‚    â””â”€â”€ test.json
    â”œâ”€â”€ images
    â”‚    â”œâ”€â”€ image1.jpg
    â”‚    â”œâ”€â”€ image1.png
    â”‚    â””â”€â”€ ...
    â””â”€â”€ ...
```

å› ä¸ºæ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„æ•°æ®é›†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå·±æ–°å»ºä¸€ä¸ª `config` å¹¶åŠ å…¥éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†ä¿¡æ¯ã€‚

å…³äºæ–°çš„ `config` çš„å‘½åï¼š

- è¿™ä¸ª config ç»§æ‰¿çš„æ˜¯ `yolov5_s-v61_syncbn_fast_8xb16-300e_coco.py`ï¼›
- è®­ç»ƒçš„ç±»ä»¥æœ¬æ•™ç¨‹æä¾›çš„æ•°æ®é›†ä¸­çš„ç±» `cat` ä¸ºä¾‹ï¼ˆå¦‚æœæ˜¯è‡ªå·±çš„æ•°æ®é›†ï¼Œå¯ä»¥è‡ªå®šä¹‰ç±»å‹çš„æ€»ç§°ï¼‰ï¼›
- æœ¬æ•™ç¨‹æµ‹è¯•çš„æ˜¾å¡å‹å·æ˜¯ 1 x 3080Ti 12G æ˜¾å­˜ï¼Œç”µè„‘å†…å­˜ 32Gï¼Œå¯ä»¥è®­ç»ƒ YOLOv5-s æœ€å¤§æ‰¹æ¬¡æ˜¯ `batch size = 32`ï¼›
- è®­ç»ƒè½®æ¬¡æ˜¯ 100 epochã€‚

ç»¼ä¸Šæ‰€è¿°ï¼šå¯ä»¥å°†å…¶å‘½åä¸º `yolov5_s-v61_syncbn_fast_1xb32-100e_cat.py`ï¼Œå¹¶å°†å…¶æ”¾ç½®åœ¨æ–‡ä»¶å¤¹ `configs/custom_dataset` ä¸­ã€‚

æˆ‘ä»¬å¯ä»¥åœ¨ `configs` ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæ–°çš„ç›®å½• `custom_dataset`ï¼ŒåŒæ—¶åœ¨é‡Œé¢æ–°å»ºè¯¥ `config` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```python
_base_ = '../yolov5/yolov5_s-v61_syncbn_fast_8xb16-300e_coco.py'

max_epochs = 100  # è®­ç»ƒçš„æœ€å¤§ epoch
data_root = './data/cat/'  # æ•°æ®é›†ç›®å½•çš„ç»å¯¹è·¯å¾„
# data_root = '/root/workspace/mmyolo/data/cat/'  # Docker å®¹å™¨é‡Œé¢æ•°æ®é›†ç›®å½•çš„ç»å¯¹è·¯å¾„

# ç»“æœä¿å­˜çš„è·¯å¾„ï¼Œå¯ä»¥çœç•¥ï¼Œçœç•¥ä¿å­˜çš„æ–‡ä»¶åä½äº work_dirs ä¸‹ config åŒåçš„æ–‡ä»¶å¤¹ä¸­
# å¦‚æœæŸä¸ª config åªæ˜¯ä¿®æ”¹äº†éƒ¨åˆ†å‚æ•°ï¼Œä¿®æ”¹è¿™ä¸ªå˜é‡å°±å¯ä»¥å°†æ–°çš„è®­ç»ƒæ–‡ä»¶ä¿å­˜åˆ°å…¶ä»–åœ°æ–¹
work_dir = './work_dirs/yolov5_s-v61_syncbn_fast_1xb32-100e_cat'

# load_from å¯ä»¥æŒ‡å®šæœ¬åœ°è·¯å¾„æˆ–è€… URLï¼Œè®¾ç½®äº† URL ä¼šè‡ªåŠ¨è¿›è¡Œä¸‹è½½ï¼Œå› ä¸ºä¸Šé¢å·²ç»ä¸‹è½½è¿‡ï¼Œæˆ‘ä»¬è¿™é‡Œè®¾ç½®æœ¬åœ°è·¯å¾„
# å› ä¸ºæœ¬æ•™ç¨‹æ˜¯åœ¨ cat æ•°æ®é›†ä¸Šå¾®è°ƒï¼Œæ•…è¿™é‡Œéœ€è¦ä½¿ç”¨ `load_from` æ¥åŠ è½½ MMYOLO ä¸­çš„é¢„è®­ç»ƒæ¨¡å‹ï¼Œè¿™æ ·å¯ä»¥åœ¨åŠ å¿«æ”¶æ•›é€Ÿåº¦çš„åŒæ—¶ä¿è¯ç²¾åº¦
load_from = './work_dirs/yolov5_s-v61_syncbn_fast_8xb16-300e_coco_20220918_084700-86e02187.pth'  # noqa

# æ ¹æ®è‡ªå·±çš„ GPU æƒ…å†µï¼Œä¿®æ”¹ batch sizeï¼ŒYOLOv5-s é»˜è®¤ä¸º 8å¡ x 16bs
train_batch_size_per_gpu = 32
train_num_workers = 4  # æ¨èä½¿ç”¨ train_num_workers = nGPU x 4

save_epoch_intervals = 2  # æ¯ interval è½®è¿­ä»£è¿›è¡Œä¸€æ¬¡ä¿å­˜ä¸€æ¬¡æƒé‡

# æ ¹æ®è‡ªå·±çš„ GPU æƒ…å†µï¼Œä¿®æ”¹ base_lrï¼Œä¿®æ”¹çš„æ¯”ä¾‹æ˜¯ base_lr_default * (your_bs / default_bs)
base_lr = _base_.base_lr / 4

anchors = [  # æ­¤å¤„å·²ç»æ ¹æ®æ•°æ®é›†ç‰¹ç‚¹æ›´æ–°äº† anchorï¼Œå…³äº anchor çš„ç”Ÿæˆï¼Œåé¢å°èŠ‚ä¼šè®²è§£
    [(68, 69), (154, 91), (143, 162)],  # P3/8
    [(242, 160), (189, 287), (391, 207)],  # P4/16
    [(353, 337), (539, 341), (443, 432)]  # P5/32
]

class_name = ('cat', )  # æ ¹æ® class_with_id.txt ç±»åˆ«ä¿¡æ¯ï¼Œè®¾ç½® class_name
num_classes = len(class_name)
metainfo = dict(
    classes=class_name,
    palette=[(220, 20, 60)]  # ç”»å›¾æ—¶å€™çš„é¢œè‰²ï¼Œéšä¾¿è®¾ç½®å³å¯
)

train_cfg = dict(
    max_epochs=max_epochs,
    val_begin=20,  # ç¬¬å‡ ä¸ª epoch åéªŒè¯ï¼Œè¿™é‡Œè®¾ç½® 20 æ˜¯å› ä¸ºå‰ 20 ä¸ª epoch ç²¾åº¦ä¸é«˜ï¼Œæµ‹è¯•æ„ä¹‰ä¸å¤§ï¼Œæ•…è·³è¿‡
    val_interval=save_epoch_intervals  # æ¯ val_interval è½®è¿­ä»£è¿›è¡Œä¸€æ¬¡æµ‹è¯•è¯„ä¼°
)

model = dict(
    bbox_head=dict(
        head_module=dict(num_classes=num_classes),
        prior_generator=dict(base_sizes=anchors),

        # loss_cls ä¼šæ ¹æ® num_classes åŠ¨æ€è°ƒæ•´ï¼Œä½†æ˜¯ num_classes = 1 çš„æ—¶å€™ï¼Œloss_cls æ’ä¸º 0
        loss_cls=dict(loss_weight=0.5 *
                      (num_classes / 80 * 3 / _base_.num_det_layers))))

train_dataloader = dict(
    batch_size=train_batch_size_per_gpu,
    num_workers=train_num_workers,
    dataset=dict(
        _delete_=True,
        type='RepeatDataset',
        # æ•°æ®é‡å¤ªå°‘çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ RepeatDataset ï¼Œåœ¨æ¯ä¸ª epoch å†…é‡å¤å½“å‰æ•°æ®é›† n æ¬¡ï¼Œè¿™é‡Œè®¾ç½® 5 æ˜¯é‡å¤ 5 æ¬¡
        times=5,
        dataset=dict(
            type=_base_.dataset_type,
            data_root=data_root,
            metainfo=metainfo,
            ann_file='annotations/trainval.json',
            data_prefix=dict(img='images/'),
            filter_cfg=dict(filter_empty_gt=False, min_size=32),
            pipeline=_base_.train_pipeline)))

val_dataloader = dict(
    dataset=dict(
        metainfo=metainfo,
        data_root=data_root,
        ann_file='annotations/trainval.json',
        data_prefix=dict(img='images/')))

test_dataloader = val_dataloader

val_evaluator = dict(ann_file=data_root + 'annotations/trainval.json')
test_evaluator = val_evaluator

optim_wrapper = dict(optimizer=dict(lr=base_lr))

default_hooks = dict(
    # è®¾ç½®é—´éš”å¤šå°‘ä¸ª epoch ä¿å­˜æ¨¡å‹ï¼Œä»¥åŠä¿å­˜æ¨¡å‹æœ€å¤šå‡ ä¸ªï¼Œ`save_best` æ˜¯å¦å¤–ä¿å­˜æœ€ä½³æ¨¡å‹ï¼ˆæ¨èï¼‰
    checkpoint=dict(
        type='CheckpointHook',
        interval=save_epoch_intervals,
        max_keep_ckpts=5,
        save_best='auto'),
    param_scheduler=dict(max_epochs=max_epochs),
    # logger è¾“å‡ºçš„é—´éš”
    logger=dict(type='LoggerHook', interval=10))
```
